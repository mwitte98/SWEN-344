<!doctype html>
<html ng-app='swenApp'>
<head>

   <% include header %>

   <!-- Stock Scripts -->
   <script src="https://code.highcharts.com/stock/highstock.src.js"></script>
   <!-- <script src = "js/highcharts.js"></script> --> <!-- THIS IS INCLUDED IN 'highcharts-ng' AND FIXES THE ERROR OF MULTIPLE NAMESPACES -->

   <!-- Typeahead Script -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>

	<title>Stocks</title>

</head>

<body id="mainCtrl" ng-controller="mainCtrl">

    <header class="navbar navbar-inverse">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">SWEN-344</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/">Home</a></li>
                    <li><a href="/stocks">Stocks</a></li>
                    <li><a href="/calendar">Calendar</a></li>
                    <li><a href="#">Log out</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="container">

       <form style="margin-left:50px;">
             Search:<br/>
             <input type="text" class="typeahead" name="symbol" ng-model="searchField" id="searchField">
             <button type="submit" ng-click="getStockQuote()">Search</button>
       </form>

       <div ng-show="stockQuote" class="hideByDefault" style="margin-top:20px;margin-left:50px;">
           <div class="well col-sm-6">
               <div class='col-sm-6'>
                   <p><b>Name: </b>{{stockQuote.Name}}</p>
               </div>
               <div class='col-sm-6'>
                   <p><b>Symbol: </b>{{stockQuote.Symbol}}</p>
               </div>
               <div class='col-sm-6'>
                   <p><b>Last Price: </b>{{stockQuote.LastPrice}}</p>
               </div>
               <div class='col-sm-6'>
                   <p><b>Change: </b>{{stockQuote.Change}}</p>
               </div>
           </div>
       </div>

       <div class='row col-sm-8' ng-show="chartConfig">
           <highchart id="chart1" config="chartConfig"></highchart>
       </div>

    </div>

    <!-- Typeahead Functionality -->
    <script>

      $('.typeahead').typeahead({minLength: 4, highlight: true, hint: true}, {
         name: 'stock-names',
         async: true,
         templates: {
            suggestion: function(data) {
               return '<p><strong>' + data["Name"] + '</strong> - ' + data["Symbol"] + '</p>';
            }
         },
         display: function(data) {
            return data["Symbol"];
         },

         source: function(query, syncResults, asyncResults) {
            return $.ajax({
               url: "/stocks/search", // CONSIDER MAKING A DIRECT CALL TO THE MARKIT API -> JSONP INSTEAD OF JSON
               type: 'GET',
               data: {search: query},
               dataType: 'json',
               success: function (json) { // THIS MAY THROW AN ERROR IF TOO MANY REQS ARE MADE PER SECOND
                  console.log("AJAX Res: " + json);
                  return asyncResults(json);
               }
            });
         }
      });

      $('.typeahead').bind('typeahead:select', function(ev, suggestion) {
         console.log('Selection: ' + suggestion["Symbol"]);
         // Angular needs to be kept up to date, so when the user presses enter to select a suggestion, set the scope var to reflect this
         angular.element(document.getElementById('mainCtrl')).scope().searchField = suggestion["Symbol"];
      });

    </script>

</body>
</html>
